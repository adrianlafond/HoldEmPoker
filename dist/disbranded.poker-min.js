/*
 * poker-game-engine v0.0.1
 * by Adrian Lafond / adrian [at] disbranded.com
 * last updated 2013-10-12
**/
!function(a,b){"function"==typeof define&&define.amd?define(["underscore"],b):"object"==typeof exports?module.exports=b(require("underscore")):(a.DISBRANDED=a.DISBRANDED||{},a.DISBRANDED.Poker=b(a._))}(this,function(a){"use strict";var b,c,d,e;return e={en:{cards:[null,"High Card","One Pair","Two Pair","Three of a Kind","Straight","Flush","Full House","Four of a Kind","Straight Flush","Royal Flush"]}},function(){var b=["2C","3C","4C","5C","6C","7C","8C","9C","TC","JC","QC","KC","AC","2D","3D","4D","5D","6D","7D","8D","9D","TD","JD","QD","KD","AD","2H","3H","4H","5H","6H","7H","8H","9H","TH","JH","QH","KH","AH","2S","3S","4S","5S","6S","7S","8S","9S","TS","JS","QS","KS","AS"],d=b.length,e=4;c=function(a){this.isShuffled=!1,this.isNew=!0,this.jokers=0,"object"==typeof a&&this.addJokers(parseInt(a.hasOwnProperty("jokers")?a.jokers:0,10)),this.reset()},c.prototype={cards:function(){return this.cardsIn.slice(0)},count:function(){return d+this.jokers},removeJokers:function(){return this.jokers=0,this.reset(),this},addJokers:function(a){return a=parseInt(a,10),isNaN(a)||(a=Math.max(0,Math.min(a,e-this.jokers)),this.jokers+=a,this.reset()),this},reset:function(){return this.cardsIn=b.slice(0),a.times(this.jokers,function(a){this.cardsIn[d+a]="W"+(a+1)},this),this.cardsOut=[],this.isShuffled=!1,this.isNew=!0,this},shuffle:function(){return this.reset(),this.cardsIn=a.shuffle(this.cardsIn),this.isShuffled=!0,this.isNew=!1,this},deal:function(){var a=null;return this.cardsIn.length>0&&(a=this.cardsIn.pop(),this.cardsOut.push(a),this.isNew=!1),a}}}(),function(){var b=function(){var a=0;return function(){return a++}}(),c={high:!0,low:!1,acesAreLow:!0,ignoreStraights:!0,ignoreFlushes:!0};d=function(e){return this instanceof d?(this.options=a.extend({id:b()},c,e||{}),this.reset(),this.options.cards&&(this.add(this.options.cards),delete this.options.cards),void 0):new d(e)}}(),d.ROYAL_FLUSH=10,d.STRAIGHT_FLUSH=9,d.FOUR_OF_A_KIND=8,d.FULL_HOUSE=7,d.FLUSH=6,d.STRAIGHT=5,d.THREE_OF_A_KIND=4,d.TWO_PAIR=3,d.ONE_PAIR=2,d.HIGH_CARD=1,d.BETTER=-1,d.WORSE=1,d.EVEN=0,d.RANKS="WAKQJT98765432",d.SUITS="SHDC",d.prototype={reset:function(){return this.cards=[],this.rankHigh=0,this.rankLow=0,this.cardsHigh=[],this.cardsLow=[],this},has:function(b){return a.contains(this.cards,b)},add:function(){return a.each(arguments,function(b){a.isString(b)?this.has(b)||(this.cards[this.cards.length]=b,this.updateRank()):a.isArray(b)&&this.add.apply(this,b)},this),this},get:function(b){return a.has(this.cards,b)?this.cards[b]:null},set:function(b,c){return b=parseInt(b,10),a.isNumber(b)&&!a.isNaN(b)&&(b=Math.max(0,Math.min(this.cards.length,b)),this.cards[b]=c,this.updateRank()),this},rank:function(a){var b="string"==typeof a&&a.length>0&&"L"===a.charAt(0).toUpperCase();return b?this.rankLow:this.rankHigh},updateRank:function(){var a;this.cards.length>=5&&(a=this.sortedCardsCopy(),this.options.high&&this.updateHigh(a),this.options.low&&this.updateLow(a))},sortedCardsCopy:function(){var a=this.cards.slice(0);return d.sortByRank(a),a},updateHigh:function(a){var b=null;if(this.rankHigh=0,a=a||this.sortedCardsCopy(),a.length>=5){if((b=d.findFlush({cards:a,sorted:!0,all:!0}))&&(this.rankHigh=d.FLUSH,this.cardsHigh=b.cards,b=d.findStraightFlush({cards:this.cardsHigh,sorted:!0,flush:!0,acesAreLow:this.options.acesAreLow})))return this.rankHigh=b.royalFlush?d.ROYAL_FLUSH:d.STRAIGHT_FLUSH,this.cardsHigh=b.cards,void 0;if(this.rankHigh<d.STRAIGHT&&(b=d.findStraight({cards:a,sorted:!0,acesAreLow:this.options.acesAreLow}),b&&(this.rankHigh=d.STRAIGHT,this.cardsHigh=b.cards)),b=d.findSets({cards:a,sorted:!0})){if(b.type>this.rankHigh)switch(this.rankHigh=b.type,this.rankHigh){case d.FOUR_OF_A_KIND:this.cardsHigh=b.sets[0].concat(b.kickers);break;case d.FULL_HOUSE:this.cardsHigh=b.sets[0].concat(b.sets[1]);break;case d.THREE_OF_A_KIND:this.cardsHigh=b.sets[0].concat(b.kickers);break;case d.TWO_PAIR:this.cardsHigh=b.sets[0].concat(b.sets[1],b.kickers);break;case d.ONE_PAIR:this.cardsHigh=b.sets[0].concat(b.kickers);break;default:this.cardsHigh=[].concat(b.kickers)}}else this.rankHigh<d.HIGH_CARD&&(this.rankHigh=d.HIGH_CARD,this.cardsHigh=a.slice(0,5))}else this.cardsHigh=[]},updateLow:function(a){var b,c,e;if(this.rankLow=0,a=a?a.slice():this.sortedCardsCopy(),this.cards.length>=5){for(this.options.acesAreLow&&"A"===d.rank(a[0])&&a.push(a.shift()),e=[],c=0,b=a.length-1;b>=0;b--)if((0===c||d.rank(e[c-1])!==d.rank(a[b]))&&(e[c++]=a[b],5===e.length))if(!this.options.ignoreFlushes&&d.findFlush(e))e=e.slice(0,4),c=4;else{if(this.options.ignoreStraights||!d.findStraight(e)){this.cardsLow=e;break}e=e.slice(0,4),c=4}}else this.cardsLow=[]},compareHighest:function(a){var b,c;if(this.rankHigh>a.rankHigh)return-1;if(this.rankHigh<a.rankHigh)return 1;if(this.cardsHigh.length&&a.cardsHigh.length)for(b=0;5>b;b++)if(c=d.compareCardsByRank(this.cardsHigh[b],a.cardsHigh[b]),0!==c)return c;return 0},compareLowest:function(){}},d.findFlush=function(){var b,c,e,f,g,h,i,j=arguments.length>0?arguments[0]:null,k=null,l=!1,m=!1,n=!1,o=null;if(a.isArray(j)?k=j:a.isObject(j)&&(k=j.cards,l=j.sorted===!0,m=j.low===!0,n=j.all===!0),!a.isArray(k)||k.length<5)return null;for(k=k.slice(0),l||d.sortByRank(k),f=k.length,b=0;4>b;b++){for(c=d.SUITS[b],h=[],g=0,e=0;f>e;e++)k[e].charAt(1)===c&&(h[g++]=k[e]);i=h.length,i>=5&&(null===o?o=m?h.slice(i-5):h.slice(0,n?i:5):(h=m?h.slice(h.length-5):h.slice(0,n?i:5),o=m?d.getBestCardsByRank({low:!0,cards:[h,o]}):d.getBestCardsByRank(h,o)))}return o?{cards:o}:null},d.findStraightFlush=function(){var b,c,e=arguments.length>0?arguments[0]:null,f=!1,g=!1,h=!1,i=!0;if(a.isArray(e)?b=e:a.isObject(e)&&(b=e.cards,f=e.flush===!0,g=e.sorted===!0,h=e.low===!0,i=!(e.acesAreLow===!1)),!a.isArray(b)||b.length<5)return null;if(b=b.slice(0),g||d.sortByRank(b),!f){if(c=d.findFlush({cards:b,sorted:g,low:h,acesAreLow:i}),!c)return null;b=c.cards}return c=d.findStraight({cards:b,sorted:g,low:h,acesAreLow:i}),c?(c.royalFlush="A"===d.rank(c.cards[0]),c):null},d.findStraight=function(){var b,c,e,f,g=arguments.length>0?arguments[0]:null,h=!1,i=!1,j=!0,k=null,l=null,m=-1;if(a.isArray(g)?b=g:a.isObject(g)&&(b=g.cards,h=g.sorted===!0,i=g.low===!0,j=!(g.acesAreLow===!1)),!a.isArray(b)||b.length<5)return null;for(b=b.slice(),h||d.sortByRank(b),e=b.length,c=0;e>c;c++)if(-1===m)m=d.RANKS.indexOf(d.rank(b[c])),k=[b[c]];else{if(f=d.RANKS.indexOf(d.rank(b[c])),f===m)continue;if(f===m+1)m=f,k.push(b[c]),j&&4===k.length&&"5"===d.rank(k[0])&&!function(){for(var a,c=0,f=d.RANKS.indexOf("A");e>c;c++){if(a=d.RANKS.indexOf(d.rank(b[c])),a===f){k[4]=b[c];break}if(a>f)break}}();else{if(k.length>=5&&(l=k.slice(),k=null,!i))break;e-c>=4&&(m=f,k=[b[c]])}}return k&&k.length>=5&&(l=l?d.getBestCardsByRank({low:i,cards:[l,k]}):k),l?i?{cards:l.slice(l.length-5)}:{cards:l.slice(0,5)}:null},d.findSets=function(){var b,c,e,f,g,h=arguments.length>0?arguments[0]:null,i=!1,j=0;if(a.isArray(h)?b=h:a.isObject(h)&&(b=h.cards,i=h.sorted===!0),!a.isArray(b)||b.length<5)return null;switch(b=b.slice(),i||d.sortByRank(b),c=function(a){for(var b,c,e=[],f=1,g=a.length;14>f;f++)for(b=[],c=0;g>c;c++)if(d.RANKS.indexOf(d.rank(a[c]))===f)b.push(a[c]),c===g-1&&e.push(b);else if(b.length>=1){e.push(b);break}return e}(b),e=[],f=[],c.sort(function(a,b){return Math.max(-1,Math.min(1,b.length-a.length))}),function(){var a,b,d=0,g=c.length,h=0;for(d=0,g=c.length;g>d;d++)4>h&&(b=c[d].length)>=2?(a=Math.min(b,5-h),e.push(c[d].slice(0,a)),j+=a,b-1>a&&f.push(c[d].slice(a)),h+=b):(f=f.length?f.concat(c[d]):c[d],h+=c[d].length),h=Math.min(5,h)}(),f.sort(d.compareCardsByRank),c[0].length){case 4:g=d.FOUR_OF_A_KIND;break;case 3:g=2===e.length?d.FULL_HOUSE:d.THREE_OF_A_KIND;break;case 2:g=2===e.length?d.TWO_PAIR:d.ONE_PAIR;break;default:g=d.HIGH_CARD}return e.length?{sets:e,kickers:f.slice(0,5-j),type:g}:null},d.getBestCardsByRank=function(){for(var a,b,c,e=arguments[0].hasOwnProperty("cards")?arguments[0].cards:Array.prototype.slice.call(arguments),f=arguments[0].hasOwnProperty("low")?arguments[0].low===!0:!1,g=f?d.isLower:d.isHigher,h=1,i=e.length,j=e[0].slice();i>h;h++)for(b=e[h].length,f?(c=e[h].slice(Math.max(0,b-5)),b=c.length):c=e[h].slice(),a=0;b>a;a++)if(g(c[a],j[a])){j=c;break}return j},d.sortByRank=function(a){a.sort(d.compareCardsByRank)},d.isHigher=function(a,b){return d.compareCardsByRank(a,b)<0},d.isLower=function(a,b){return d.compareCardsByRank(a,b)>0},d.compareCardsByRank=function(a,b){var c=d.RANKS.indexOf(d.rank(a)),e=d.RANKS.indexOf(d.rank(b));return c-e},d.compareCardsBySuit=function(a,b){var c=d.SUITS.indexOf(d.suit(a)),e=d.SUITS.indexOf(d.suit(b));return c-e},d.compareSetSize=function(a,b){var c=a.length,d=b.length;return d-c},d.rank=function(a){return a.charAt(0)},d.suit=function(a){return a.charAt(1)},b=function(){this.name="Poker"},b.prototype={},b.Deck=c,b.Hand=d,b.lingo=function(b){return b=b||"en",e.hasOwnProperty(b)?{cards:a.clone(e[b].cards)}:null},b});